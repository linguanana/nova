<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>語音與字幕生成器</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        /* Custom scrollbar for better aesthetics */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-2xl border border-gray-200">
        <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-2">
            語音與字幕生成器
        </h1>
        <p class="text-center text-gray-500 mb-8">
            輸入文字，選擇一個聲音，然後生成語音。
        </p>

        <!-- Text Input Area -->
        <div class="mb-6">
            <label for="text-input" class="block text-sm font-medium text-gray-700 mb-2">
                輸入您的文字
            </label>
            <textarea
                id="text-input"
                class="w-full p-4 h-40 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200"
                placeholder="請在這裡輸入您的文字..."
            ></textarea>
        </div>

        <!-- Voice Selector -->
        <div class="mb-6">
            <label for="voice-selector" class="block text-sm font-medium text-gray-700 mb-2">
                選擇一個聲音
            </label>
            <select
                id="voice-selector"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200"
            >
                <!-- Voices will be populated by JavaScript -->
            </select>
        </div>

        <!-- Generate Button -->
        <div class="mb-6">
            <button
                id="generate-button"
                class="w-full py-4 px-6 rounded-lg font-bold text-white transition-all duration-200 bg-indigo-600 hover:bg-indigo-700 active:scale-95"
            >
                生成音訊
            </button>
        </div>

        <!-- Dynamic Content Area -->
        <div id="dynamic-content-area"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const textInput = document.getElementById('text-input');
            const voiceSelector = document.getElementById('voice-selector');
            const generateButton = document.getElementById('generate-button');
            const dynamicContentArea = document.getElementById('dynamic-content-area');

            // Predefined list of voices
            const voices = [
                { name: 'Kore', label: 'Kore (Firm)' },
                { name: 'Puck', label: 'Puck (Upbeat)' },
                { name: 'Charon', label: 'Charon (Informative)' },
                { name: 'Zephyr', label: 'Zephyr (Bright)' },
                { name: 'Fenrir', label: 'Fenrir (Excitable)' },
                { name: 'Leda', label: 'Leda (Youthful)' },
            ];

            // Populate voice selector
            voices.forEach(v => {
                const option = document.createElement('option');
                option.value = v.name;
                option.textContent = v.label;
                voiceSelector.appendChild(option);
            });

            // Base64 to ArrayBuffer utility function
            const base64ToArrayBuffer = (base64) => {
                const binaryString = atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            };

            // PCM to WAV Blob utility function
            const pcmToWav = (pcmData, sampleRate) => {
                const dataView = new DataView(new ArrayBuffer(44 + pcmData.length));
                let offset = 0;

                const writeString = (view, offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };

                writeString(dataView, offset, 'RIFF');
                offset += 4;
                dataView.setUint32(offset, 36 + pcmData.length, true);
                offset += 4;
                writeString(dataView, offset, 'WAVE');
                offset += 4;

                writeString(dataView, offset, 'fmt ');
                offset += 4;
                dataView.setUint32(offset, 16, true);
                offset += 4;
                dataView.setUint16(offset, 1, true);
                offset += 2;
                dataView.setUint16(offset, 1, true);
                offset += 2;
                dataView.setUint32(offset, sampleRate, true);
                offset += 4;
                dataView.setUint32(offset, sampleRate * 2, true);
                offset += 4;
                dataView.setUint16(offset, 2, true);
                offset += 2;
                dataView.setUint16(offset, 16, true);
                offset += 2;

                writeString(dataView, offset, 'data');
                offset += 4;
                dataView.setUint32(offset, pcmData.length, true);
                offset += 4;

                for (let i = 0; i < pcmData.length; i++) {
                    dataView.setUint8(offset + i, pcmData[i]);
                }

                return new Blob([dataView], { type: 'audio/wav' });
            };

            // Custom fetch with exponential backoff for retries
            const exponentialBackoffFetch = async (url, options, retries = 5, delay = 1000) => {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.status === 429 && i < retries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                            continue;
                        }
                        if (!response.ok) {
                            throw new Error(`API error: ${response.statusText}`);
                        }
                        return response;
                    } catch (error) {
                        if (i === retries - 1) {
                            throw error;
                        }
                        await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                    }
                }
            };

            // Function to display messages and audio player
            const renderContent = (contentHtml, type = 'html') => {
                dynamicContentArea.innerHTML = '';
                if (type === 'html') {
                    dynamicContentArea.innerHTML = contentHtml;
                } else if (type === 'audio') {
                    const audioDiv = document.createElement('div');
                    audioDiv.className = 'p-4 bg-gray-100 rounded-lg';
                    audioDiv.innerHTML = `
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">已生成的音訊</h3>
                        <audio controls src="${contentHtml}" class="w-full"></audio>
                    `;
                    dynamicContentArea.appendChild(audioDiv);
                }
            };

            const setLoading = (isLoading) => {
                generateButton.disabled = isLoading;
                const buttonText = isLoading ? '正在生成中...' : '生成音訊';
                generateButton.innerHTML = buttonText;
                generateButton.classList.toggle('bg-indigo-300', isLoading);
                generateButton.classList.toggle('hover:bg-indigo-700', !isLoading);
                generateButton.classList.toggle('active:scale-95', !isLoading);

                if (isLoading) {
                    const loadingHtml = `
                        <div class="flex justify-center items-center py-4">
                            <svg class="animate-spin h-6 w-6 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="ml-3 text-gray-600">正在生成語音，這可能需要幾秒鐘...</span>
                        </div>
                    `;
                    renderContent(loadingHtml);
                } else {
                    if (!dynamicContentArea.querySelector('audio')) {
                         renderContent('');
                    }
                }
            };

            // Event listener for the generate button
            generateButton.addEventListener('click', async () => {
                const text = textInput.value.trim();
                const voice = voiceSelector.value;

                if (!text) {
                    renderContent('<div class="p-4 bg-red-100 text-red-700 rounded-lg mb-6 text-center">請輸入一些文字。</div>');
                    return;
                }

                let audioUrl = '';
                setLoading(true);

                const prompt = `Say in a natural tone: ${text}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: voice }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                try {
                    const response = await exponentialBackoffFetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        const pcmData = base64ToArrayBuffer(audioData);
                        const sampleRate = 16000;
                        const wavBlob = pcmToWav(new Uint8Array(pcmData), sampleRate);
                        audioUrl = URL.createObjectURL(wavBlob);
                        renderContent(audioUrl, 'audio');
                    } else {
                        renderContent('<div class="p-4 bg-red-100 text-red-700 rounded-lg mb-6 text-center">音訊產生失敗，請再試一次。</div>');
                    }
                } catch (err) {
                    console.error(err);
                    renderContent(`<div class="p-4 bg-red-100 text-red-700 rounded-lg mb-6 text-center">錯誤: ${err.message}</div>`);
                } finally {
                    setLoading(false);
                }
            });
        });
    </script>
</body>
</html>
