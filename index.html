<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多語言轉換工具</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for Lucide icons */
        .icon {
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-200 min-h-screen p-8 flex items-center justify-center">

    <div class="w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-8 space-y-8">
        <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-6 tracking-tight">
            多語言轉換工具
        </h1>

        <!-- Error Message Container -->
        <div id="error-message" class="hidden bg-red-500 text-white p-4 rounded-xl items-center gap-2">
            <svg class="icon" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            <span class="font-medium" id="error-text"></span>
        </div>

        <!-- Input for YouTube URL -->
        <div class="space-y-4">
            <label for="youtube-url" class="block text-sm font-medium text-gray-700">
                YouTube 網址
            </label>
            <input
                id="youtube-url"
                type="text"
                placeholder="例如: https://www.youtube.com/watch?v=..."
                class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
            />
        </div>

        <div class="relative flex items-center justify-center my-6">
            <div class="w-full h-px bg-gray-300"></div>
            <span class="absolute bg-white px-4 text-gray-500 text-sm font-medium">或</span>
        </div>

        <!-- Compact Input for MP3 File -->
        <div class="space-y-4">
            <label for="mp3-file-input" class="block text-sm font-medium text-gray-700">
                上傳 MP3 檔案
            </label>
            <div class="flex items-center space-x-2">
                <input
                    id="mp3-file-input"
                    type="file"
                    class="hidden"
                    accept=".mp3"
                />
                <label
                    for="mp3-file-input"
                    id="mp3-file-label"
                    class="flex-grow p-3 bg-gray-100 text-gray-500 rounded-xl border border-gray-300 cursor-pointer transition-colors hover:bg-gray-200"
                >
                    選擇檔案...
                </label>
            </div>
            <p id="file-name-display" class="text-sm text-gray-600 text-center mt-2 hidden">
                已選擇檔案: <span class="font-semibold"></span>
            </p>
        </div>

        <div class="relative flex items-center justify-center my-6">
            <div class="w-full h-px bg-gray-300"></div>
            <span class="absolute bg-white px-4 text-gray-500 text-sm font-medium">或</span>
        </div>

        <!-- Input for Direct Text -->
        <div class="space-y-4">
            <label for="source-text" class="block text-sm font-medium text-gray-700">
                直接輸入文字
            </label>
            <textarea
                id="source-text"
                placeholder="在此輸入您想要轉換的文字..."
                rows="5"
                class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors resize-y"
            ></textarea>
        </div>

        <!-- Language Selection -->
        <div class="space-y-4">
            <label for="language-select" class="block text-sm font-medium text-gray-700">
                選擇目標語言
            </label>
            <select
                id="language-select"
                class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
            >
                <option value="zh-TW">繁體中文</option>
                <option value="en-US">English (US)</option>
                <option value="ja-JP">日本語</option>
                <option value="ko-KR">한국어</option>
                <option value="es-US">Español (US)</option>
                <option value="it-IT">Italiano</option>
                <option value="fr-FR">Français</option>
            </select>
        </div>

        <!-- Process Button -->
        <button
            id="process-btn"
            class="w-full flex items-center justify-center py-3 px-6 rounded-xl text-lg font-bold text-white transition-all duration-300 bg-indigo-600 hover:bg-indigo-700 shadow-md hover:shadow-lg"
        >
            開始轉換
        </button>

        <!-- Loading Indicator -->
        <div id="loading-spinner" class="hidden flex items-center justify-center text-indigo-600 space-x-2">
            <svg class="animate-spin" width="24" height="24" viewBox="0 0 24 24"><path d="M12 2v4m0 12v4m8.5-10h-4m-13 0h-4M4.9 4.9l2.8 2.8m10.3 10.3l2.8 2.8M2 12h4m12 0h4m-15.5-2.5l-2.8-2.8m10.3 10.3l2.8 2.8"/></svg>
            <span>處理中...</span>
        </div>

        <!-- Results Container -->
        <div id="results-container" class="hidden mt-8 p-6 bg-gray-50 rounded-2xl shadow-inner space-y-4">
            <h2 class="text-2xl font-bold text-gray-800 text-center">
                轉換完成！
            </h2>
            <div class="space-y-4">
                <div class="border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                    <audio id="translated-audio" controls class="w-full">
                        您的瀏覽器不支援音訊元素。
                    </audio>
                </div>
                <a
                    id="download-audio-btn"
                    download="translated_audio.wav"
                    class="w-full flex items-center justify-center py-3 px-6 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition-colors"
                >
                    <svg class="icon mr-2" width="20" height="20" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    下載 WAV
                </a>
            </div>

            <div class="mt-4 space-y-2">
                <h3 class="text-xl font-semibold text-gray-800">
                    生成的 SRT 字幕
                </h3>
                <textarea
                    id="srt-content"
                    readonly
                    class="w-full h-40 p-4 border border-gray-300 rounded-xl bg-white font-mono text-sm resize-none"
                ></textarea>
                <button
                    id="download-srt-btn"
                    class="w-full flex items-center justify-center py-3 px-6 bg-blue-500 text-white font-bold rounded-xl hover:bg-blue-600 transition-colors"
                >
                    <svg class="icon mr-2" width="20" height="20" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    下載 SRT 檔
                </button>
            </div>
        </div>
    </div>

    <script>
        // API placeholders and helper functions
        const apiKey = "";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        const pcmToWav = (pcmData, sampleRate) => {
            const dataView = new DataView(new ArrayBuffer(44 + pcmData.length * 2));
            let offset = 0;
            const writeString = (str) => {
                for (let i = 0; i < str.length; i++) {
                    dataView.setUint8(offset + i, str.charCodeAt(i));
                }
            };
            const writeUint16 = (val) => {
                dataView.setUint16(offset, val, true);
                offset += 2;
            };
            const writeUint32 = (val) => {
                dataView.setUint32(offset, val, true);
                offset += 4;
            };
            writeString('RIFF'); offset += 4;
            writeUint32(36 + pcmData.length * 2);
            writeString('WAVE'); offset += 4;
            writeString('fmt '); offset += 4;
            writeUint32(16);
            writeUint16(1);
            writeUint16(1);
            writeUint32(sampleRate);
            writeUint32(sampleRate * 2);
            writeUint16(2);
            writeUint16(16);
            writeString('data'); offset += 4;
            writeUint32(pcmData.length * 2);
            for (let i = 0; i < pcmData.length; i++) {
                dataView.setInt16(offset, pcmData[i], true);
                offset += 2;
            }
            return new Blob([dataView], { type: 'audio/wav' });
        };

        const getVoiceForLanguage = (langCode) => {
            switch (langCode) {
                case 'zh-TW': return 'Kore';
                case 'en-US': return 'Puck';
                case 'ja-JP': return 'Alnilam';
                case 'ko-KR': return 'Zephyr';
                case 'es-US': return 'Charon';
                case 'it-IT': return 'Algieba';
                case 'fr-FR': return 'Laomedeia';
                default: return 'Kore';
            }
        };

        // DOM elements
        const youtubeUrlInput = document.getElementById('youtube-url');
        const mp3FileInput = document.getElementById('mp3-file-input');
        const mp3FileLabel = document.getElementById('mp3-file-label');
        const sourceTextInput = document.getElementById('source-text');
        const languageSelect = document.getElementById('language-select');
        const processBtn = document.getElementById('process-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsContainer = document.getElementById('results-container');
        const translatedAudioElement = document.getElementById('translated-audio');
        const srtContentTextarea = document.getElementById('srt-content');
        const downloadAudioBtn = document.getElementById('download-audio-btn');
        const downloadSrtBtn = document.getElementById('download-srt-btn');
        const errorMessageDiv = document.getElementById('error-message');
        const errorTextSpan = document.getElementById('error-text');
        const fileNameDisplay = document.getElementById('file-name-display');
        const fileNameSpan = fileNameDisplay.querySelector('span');

        // Event listeners
        mp3FileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileNameSpan.textContent = e.target.files[0].name;
                fileNameDisplay.classList.remove('hidden');
            } else {
                fileNameSpan.textContent = '';
                fileNameDisplay.classList.add('hidden');
            }
        });

        processBtn.addEventListener('click', async () => {
            // Reset state
            errorMessageDiv.classList.add('hidden');
            resultsContainer.classList.add('hidden');

            const youtubeUrl = youtubeUrlInput.value.trim();
            const mp3File = mp3FileInput.files[0];
            const sourceText = sourceTextInput.value.trim();
            const selectedLanguage = languageSelect.value;

            // Validation
            if (!youtubeUrl && !mp3File && !sourceText) {
                errorTextSpan.textContent = '請輸入YouTube網址、上傳MP3檔案或直接輸入文字。';
                errorMessageDiv.classList.remove('hidden');
                return;
            }

            // UI state: Show loading, disable button
            loadingSpinner.classList.remove('hidden');
            processBtn.disabled = true;
            processBtn.classList.add('bg-indigo-300', 'cursor-not-allowed');
            processBtn.innerHTML = `<svg class="animate-spin mr-2" width="24" height="24" viewBox="0 0 24 24"><path d="M12 2v4m0 12v4m8.5-10h-4m-13 0h-4M4.9 4.9l2.8 2.8m10.3 10.3l2.8 2.8M2 12h4m12 0h4m-15.5-2.5l-2.8-2.8m10.3 10.3l2.8 2.8"/></svg>處理中...`;

            try {
                let originalText = '';
                if (sourceText) {
                    originalText = sourceText;
                } else if (youtubeUrl || mp3File) {
                    // Placeholder text for YouTube/MP3, as direct processing is not available
                    originalText = "Hello, everyone. Today, we're going to learn about the weather. We will talk about sun, rain, and snow. Let's start with the sun. When the sun is out, we can play outside and feel warm. The sky is usually blue. What about rain? When it rains, we use an umbrella. Rain helps the plants and flowers grow. Finally, there's snow. Snow is cold and white. We can build a snowman when it snows. That's all for today. Thank you for listening!";
                }

                // Step 2: Translate the text
                const translatePrompt = `Translate the following text into the language code ${selectedLanguage}. The text is for a children's song or educational video. Ensure the translation is simple and clear for kids: "${originalText}"`;
                const translatePayload = { contents: [{ role: "user", parts: [{ text: translatePrompt }] }] };
                const translateApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const translateResponse = await fetch(translateApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(translatePayload)
                });
                const translateResult = await translateResponse.json();
                const translatedText = translateResult?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!translatedText) {
                    throw new Error('翻譯失敗，請再試一次。');
                }

                // Step 3: Use Text-to-Speech to create the audio
                const voiceName = getVoiceForLanguage(selectedLanguage);
                const ttsPrompt = `Say cheerfully: ${translatedText}`;
                const ttsPayload = {
                    contents: [{ parts: [{ text: ttsPrompt }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName } } }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                const ttsResponse = await fetch(ttsApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ttsPayload)
                });
                const ttsResult = await ttsResponse.json();
                const part = ttsResult?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (!audioData || !mimeType || !mimeType.startsWith("audio/")) {
                    throw new Error('語音生成失敗。');
                }

                const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);

                // Step 4: Create a placeholder SRT file
                const lines = translatedText.split(/[.。?!\n]/); // Split by common punctuation
                let srtOutput = '';
                let currentTime = 0;
                let srtIndex = 1;
                lines.forEach((line) => {
                    const trimmedLine = line.trim();
                    if (trimmedLine) {
                        const startMs = currentTime;
                        const durationMs = trimmedLine.length * 120 + 1000;
                        const endMs = currentTime + durationMs;

                        const formatTime = (ms) => {
                            const hours = Math.floor(ms / 3600000);
                            const minutes = Math.floor((ms % 3600000) / 60000);
                            const seconds = Math.floor((ms % 60000) / 1000);
                            const milliseconds = ms % 1000;
                            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')},${String(milliseconds).padStart(3, '0')}`;
                        };

                        srtOutput += `${srtIndex++}\n`;
                        srtOutput += `${formatTime(startMs)} --> ${formatTime(endMs)}\n`;
                        srtOutput += `${trimmedLine}\n\n`;
                        currentTime = endMs + 500;
                    }
                });

                // Update UI with results
                translatedAudioElement.src = audioUrl;
                downloadAudioBtn.href = audioUrl;
                srtContentTextarea.value = srtOutput;
                downloadSrtBtn.onclick = () => {
                    const file = new Blob([srtOutput], { type: 'text/plain' });
                    const element = document.createElement("a");
                    element.href = URL.createObjectURL(file);
                    element.download = "translated_subtitles.srt";
                    document.body.appendChild(element);
                    element.click();
                };

                resultsContainer.classList.remove('hidden');

            } catch (e) {
                console.error(e);
                errorTextSpan.textContent = `發生錯誤: ${e.message}`;
                errorMessageDiv.classList.remove('hidden');
            } finally {
                // UI state: Hide loading, enable button
                loadingSpinner.classList.add('hidden');
                processBtn.disabled = false;
                processBtn.classList.remove('bg-indigo-300', 'cursor-not-allowed');
                processBtn.innerHTML = '開始轉換';
            }
        });
    </script>
</body>
</html>
